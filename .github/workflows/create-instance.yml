name: Ubuntu ARM Instance

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      manual_trigger_reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æµ‹è¯•æˆ–ç´§æ€¥æ“ä½œ'

jobs:
  manage-oci-instances:
    runs-on: ubuntu-latest
    env:
      OCI_CLI_USER: ${{ secrets.OCI_USER }}
      OCI_CLI_TENANCY: ${{ secrets.OCI_TENANCY }}
      OCI_CLI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
      OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_PRIVATE_KEY }}
      OCI_CLI_REGION: ${{ secrets.OCI_REGION }}
      COMPARTMENT_ID: ${{ secrets.OCI_TENANCY }}
      SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
      IMAGE_ID: "ocid1.image.oc1.ap-singapore-1.aaaaaaaa5a3xwkk5vaichk47fms2uzvsqeriats2uorf6kwgq3l3nwrbhipa"
      INSTANCE_SHAPE: "VM.Standard.A1.Flex"
      OCPUS: 4
      MEMORY_GB: 24
      EXPECTED_ERRORS: '[\"Out of host capacity.\", \"Too many requests for the user\", \"The connection to endpoint timed out.\"]'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up OCI CLI
        run: |
          curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh | bash -s -- --accept-all-defaults
          echo 'export PATH=$HOME/bin:$PATH' >> ~/.bashrc
          source ~/.bashrc
          echo "$HOME/bin" >> $GITHUB_PATH
          export PATH="$HOME/bin:$PATH"

      - name: Configure OCI CLI
        env:
          OCI_CLI_AUTH: api_key
        run: |
          mkdir -p ~/.oci
          echo "${{ env.SSH_PUBLIC_KEY }}" > /tmp/oci_api_key.pub
          echo "***" >> /tmp/oci_api_key.pub
          chmod 600 /tmp/oci_api_key.pub
          cat > ~/.oci/config <<EOF
          [DEFAULT]
          user=${{ env.OCI_CLI_USER }}
          fingerprint=${{ env.OCI_CLI_FINGERPRINT }}
          tenancy=${{ env.OCI_CLI_TENANCY }}
          region=${{ env.OCI_CLI_REGION }}
          key_file=/tmp/oci_api_key.pub
          EOF
          echo "âœ… OCI CLI é…ç½®å®Œæˆ"

      - name: Check VM.Standard.A1.Flex instance existence
        id: check_instances
        run: |
          instances=$(oci compute instance list \
            --compartment-id "${{ env.COMPARTMENT_ID }}" \
            --query 'data[?shape==`VM.Standard.A1.Flex`].{id:id, name:"display-name", shape:shape, state:"lifecycle-state"}' \
            --raw-output)
          echo "output=${instances}" >> $GITHUB_OUTPUT

      - name: Check if instances exist
        id: check_instances
        run: |
          if [ "$(echo "${{ steps.check_instances.outputs.output }}" | jq length)" -gt 0 ]; then
            echo "âŒ æ£€æµ‹åˆ°æ­£åœ¨è¿è¡Œæˆ–éç»ˆæ­¢çŠ¶æ€çš„ VM.Standard.A1.Flex å®ä¾‹"
            echo "disable_workflow=true" >> $GITHUB_ENV
          else
            echo "âœ… æ²¡æœ‰è¿è¡Œä¸­çš„å®ä¾‹ï¼Œç»§ç»­æ‰§è¡Œ"
            echo "disable_workflow=false" >> $GITHUB_ENV
          fi

      - name: Comment out the cron schedule in workflow
        if: env.disable_workflow == 'true'
        run: |
          echo "æ³¨é‡Šæ‰å·¥ä½œæµä¸­çš„ cron è°ƒåº¦éƒ¨åˆ†"
          
          # ä½¿ç”¨ sed æ³¨é‡Šæ‰ cron è§¦å‘å™¨éƒ¨åˆ†
          # sed -i '/cron:/,/jobs:/s/^/  # /' .github/workflows/create-instance.yml

          # å¦‚æœéœ€è¦æ³¨é‡Šæ‰æ•´ä¸ªå·¥ä½œæµï¼Œå¯ä»¥è¿™æ ·ï¼š
          sed -i 's/^/  # /' .github/workflows/create-instance.yml

      - name: Commit changes to disable workflow
        if: env.disable_workflow == 'true'
        run: |
          git config --global user.email "workflow@example.com"
          git config --global user.name "workflow-bot"
          git add .github/workflows/create-instance.yml
          git commit -m "Disabling workflow by commenting out the cron schedule"
          git push origin HEAD
          
          exit 1

      - name: Get Availability Domain Name
        id: get_availability_domain
        run: |
          ad=$(oci iam availability-domain list \
            --compartment-id "${{ env.COMPARTMENT_ID }}" \
            --query 'data[0].name' --raw-output)
          echo "output=${ad}" >> $GITHUB_OUTPUT
          echo "âœ… AD: ${ad}"

      - name: Get VCN ID
        id: get_vcn_id
        run: |
          vcn_id=$(oci network vcn list \
            --compartment-id "${{ env.COMPARTMENT_ID }}" \
            --query 'data[0].id' --raw-output)
          echo "output=${vcn_id}" >> $GITHUB_OUTPUT
          echo "âœ… VCN ID: ${vcn_id}"

      - name: Get Subnet ID
        id: get_subnet_id
        run: |
          subnet_id=$(oci network subnet list \
            --compartment-id "${{ env.COMPARTMENT_ID }}" \
            --vcn-id "${{ steps.get_vcn_id.outputs.output }}" \
            --query 'data[0].id' --raw-output)
          echo "output=${subnet_id}" >> $GITHUB_OUTPUT
          echo "âœ… Subnet ID: ${subnet_id}"

      - name: Create new Ubuntu ARM instance (4C24G)
        id: created_ubuntu
        run: |
          echo "=== æ­£åœ¨åˆ›å»ºæ–°çš„ Ubuntu ARM å®ä¾‹ ==="
          set +e
          temp_error_file=$(mktemp)
          instance_response=$(oci compute instance launch \
            --availability-domain "${{ steps.get_availability_domain.outputs.output }}" \
            --compartment-id "${{ env.COMPARTMENT_ID }}" \
            --shape "${{ env.INSTANCE_SHAPE }}" \
            --shape-config "{\"ocpus\": ${{ env.OCPUS }}, \"memoryInGBs\": ${{ env.MEMORY_GB }}}" \
            --display-name "ubuntu-arm-4c24g-$(date +%s)" \
            --image-id "${{ env.IMAGE_ID }}" \
            --subnet-id "${{ steps.get_subnet_id.outputs.output }}" \
            --assign-public-ip true \
            --ssh-authorized-keys-file <(echo "${{ env.SSH_PUBLIC_KEY }}") 2>"$temp_error_file")

          exit_code=$?
          error_content=$(cat "$temp_error_file")
          rm -f "$temp_error_file"

          if [ $exit_code -eq 0 ]; then
              echo "âœ… å®ä¾‹åˆ›å»ºæˆåŠŸï¼"
              echo "$instance_response"
              echo "error_message=" >> $GITHUB_OUTPUT
          else
              error_message=$(echo "$error_content" | grep -o '"message": "[^"]*' | cut -d'"' -f4 || echo "Unknown error")
              echo "âŒ å®ä¾‹åˆ›å»ºå¤±è´¥ï¼"
              echo "$error_content"
              echo "error_message=$error_message" >> $GITHUB_OUTPUT
          fi

          set -e

      - name: Check error message
        run: |
          error_message="${{ steps.created_ubuntu.outputs.error_message }}"

          if [[ -n "$error_message" ]]; then
            echo "âš ï¸ OCI è¿”å›çš„é”™è¯¯: $error_message"

            # æ£€æŸ¥é”™è¯¯æ¶ˆæ¯æ˜¯å¦åœ¨é¢„æœŸé”™è¯¯åˆ—è¡¨ä¸­
            in_expected=$(echo "${{ env.EXPECTED_ERRORS }}" | jq --arg msg "$error_message" -e '.[] | select(. == $msg)' > /dev/null; echo $?)

            # å¦‚æœé”™è¯¯ä¸åœ¨é¢„æœŸåˆ—è¡¨ä¸­ï¼Œåˆ™è§¦å‘å¤±è´¥ï¼ˆæŠ›å‡ºå¼‚å¸¸ï¼‰
            if [[ "$in_expected" -ne 0 ]]; then
              echo "âŒ é‡åˆ°æ„å¤–çš„é”™è¯¯: $error_message"
              echo "è‡ªå®šä¹‰å¼‚å¸¸: è¿™ä¸ªé”™è¯¯æ˜¯ä¸é¢„æœŸçš„ã€‚"
              exit 1  # è§¦å‘å¤±è´¥
            else
              echo "âœ… é¢„æœŸçš„é”™è¯¯å‘ç”Ÿï¼Œç»§ç»­æ‰§è¡Œå·¥ä½œæµã€‚"
            fi
          else
            echo "âœ… å®ä¾‹æˆåŠŸåˆ›å»ºã€‚"
          fi
          
      - name: Cleanup OCI configuration
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç† OCI é…ç½®æ–‡ä»¶å’Œä¸´æ—¶æ–‡ä»¶..."
          rm -f /tmp/oci_api_key.pub
          rm -f ~/.oci/config
          # å¦‚æœç›®å½•ä¸ºç©ºï¼Œä¹Ÿåˆ é™¤ .oci ç›®å½•
          rmdir ~/.oci 2>/dev/null || true
          echo "âœ… æ¸…ç†å®Œæˆ"