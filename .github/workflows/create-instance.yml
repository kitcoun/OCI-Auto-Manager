name: OCI Ubuntu ARM Instance Auto-Manager

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      manual_trigger_reason:
        description: '手动触发原因'
        required: false
        default: '测试或紧急操作'

jobs:
  manage-oci-instances:
    runs-on: ubuntu-latest
    env:
      OCI_CLI_USER: ${{ secrets.OCI_USER }}
      OCI_CLI_TENANCY: ${{ secrets.OCI_TENANCY }}
      OCI_CLI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
      OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_PRIVATE_KEY }}
      OCI_CLI_REGION: ${{ secrets.OCI_REGION }}
      COMPARTMENT_ID: ${{ secrets.OCI_TENANCY }}
      SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
      IMAGE_ID: "ocid1.image.oc1.ap-singapore-1.aaaaaaaa5a3xwkk5vaichk47fms2uzvsqeriats2uorf6kwgq3l3nwrbhipa"
      INSTANCE_SHAPE: "VM.Standard.A1.Flex"
      OCPUS: 4
      MEMORY_GB: 24

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up OCI CLI
        run: |
          curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh | bash -s -- --accept-all-defaults
          echo 'export PATH=$HOME/bin:$PATH' >> ~/.bashrc
          source ~/.bashrc
          echo "$HOME/bin" >> $GITHUB_PATH
          export PATH="$HOME/bin:$PATH"

      - name: Configure OCI CLI
        env:
          OCI_CLI_AUTH: api_key
        run: |
          mkdir -p ~/.oci
          echo "${{ env.SSH_PUBLIC_KEY }}" > /tmp/oci_api_key.pub
          chmod 600 ~/.oci/oci_api_key.pem
          cat > ~/.oci/config <<EOF
          [DEFAULT]
          user=${{ env.OCI_CLI_USER }}
          fingerprint=${{ env.OCI_CLI_FINGERPRINT }}
          tenancy=${{ env.OCI_CLI_TENANCY }}
          region=${{ env.OCI_CLI_REGION }}
          key_file=/tmp/oci_api_key.pub
          EOF
          echo "✅ OCI CLI 配置完成"

      - name: Check VM.Standard.A1.Flex instance existence
        id: check_instances
        run: |
          instances=$(oci compute instance list \
            --compartment-id "${{ env.COMPARTMENT_ID }}" \
            --query 'data[?shape==`VM.Standard.A1.Flex`].{id:id, name:"display-name", shape:shape, state:"lifecycle-state"}' \
            --raw-output)
          echo "::set-output name=output::${instances}"

      - name: Check if instances exist
        run: |
          if [ "$(echo "${{ steps.check_instances.outputs.output }}" | jq length)" -gt 0 ]; then
            echo "❌ 检测到正在运行或非终止状态的 VM.Standard.A1.Flex 实例"
            exit 1
          else
            echo "✅ 没有运行中的实例，继续执行"
          fi

      - name: Get Availability Domain Name
        id: get_availability_domain
        run: |
          ad=$(oci iam availability-domain list \
            --compartment-id "${{ env.COMPARTMENT_ID }}" \
            --query 'data[0].name' --raw-output)
          echo "::set-output name=output::${ad}"
          echo "✅ AD: ${ad}"

      - name: Get VCN ID
        id: get_vcn_id
        run: |
          vcn_id=$(oci network vcn list \
            --compartment-id "${{ env.COMPARTMENT_ID }}" \
            --query 'data[0].id' --raw-output)
          echo "::set-output name=output::${vcn_id}"
          echo "✅ VCN ID: ${vcn_id}"

      - name: Get Subnet ID
        id: get_subnet_id
        run: |
          subnet_id=$(oci network subnet list \
            --compartment-id "${{ env.COMPARTMENT_ID }}" \
            --vcn-id "${{ steps.get_vcn_id.outputs.output }}" \
            --query 'data[0].id' --raw-output)
          echo "::set-output name=output::${subnet_id}"
          echo "✅ Subnet ID: ${subnet_id}"

      # - name: Set ssh key file
      #   run: |
      #     echo "${{ env.SSH_PUBLIC_KEY }}" > /tmp/ssh_key.pub
      #     echo "✅ SSH 公钥文件已写入 /tmp/ssh_key.pub"

      - name: Create new Ubuntu ARM instance (4C24G)
        run: |
          echo "=== 正在创建新的 Ubuntu ARM 实例 ==="
          oci compute instance launch \
            --availability-domain "${{ steps.get_availability_domain.outputs.output }}" \
            --compartment-id "${{ env.COMPARTMENT_ID }}" \
            --shape "${{ env.INSTANCE_SHAPE }}" \
            --shape-config "{\"ocpus\": ${{ env.OCPUS }}, \"memoryInGBs\": ${{ env.MEMORY_GB }}}" \
            --display-name "ubuntu-arm-4c24g" \
            --image-id "${{ env.IMAGE_ID }}" \
            --subnet-id "${{ steps.get_subnet_id.outputs.output }}" \
            --assign-public-ip true \
            --ssh-authorized-keys-file <(echo "${{ env.SSH_PUBLIC_KEY }}")
          echo "✅ 实例创建命令已执行"
