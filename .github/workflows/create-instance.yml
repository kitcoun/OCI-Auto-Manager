# https://github.com/oracle-actions/run-oci-cli-command/
name: OCI Ubuntu ARM Instance Auto-Manager

# 触发条件
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      manual_trigger_reason:
        description: '手动触发原因'
        required: false
        default: '测试或紧急操作'

jobs:
  manage-oci-instances:
    runs-on: ubuntu-latest
    env:
      OCI_CLI_USER: ${{ secrets.OCI_USER }}
      OCI_CLI_TENANCY: ${{ secrets.OCI_TENANCY }}
      OCI_CLI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
      OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_PRIVATE_KEY }}
      OCI_CLI_REGION: ${{ secrets.OCI_REGION }}
      COMPARTMENT_ID: ${{ secrets.OCI_TENANCY }}
      SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
      IMAGE_ID: "ocid1.image.oc1.ap-singapore-1.aaaaaaaa5a3xwkk5vaichk47fms2uzvsqeriats2uorf6kwgq3l3nwrbhipa"
      INSTANCE_SHAPE: "VM.Standard.A1.Flex"
      OCPUS: 4
      MEMORY_GB: 24

    steps:
      # 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 安装jq（用于JSON处理）
      # - name: Install dependencies
      #   run: sudo apt-get update && sudo apt-get install -y jq

      # 检查是否存在运行中的VM.Standard.A1.Flex实例
      - name: Check VM.Standard.A1.Flex instance existence
        uses: oracle-actions/run-oci-cli-command@v1.3.2
        id: check_instances
        with:
          silent: false
          command: 'compute instance list --compartment-id ${{ env.COMPARTMENT_ID }}'
          query: 'data[?shape==`VM.Standard.A1.Flex`].{id:id, name:\"display-name\", shape:shape, state:\"lifecycle-state\"}'

      # 判断是否找到实例，并决定是否继续
      - name: Check if instances exist
        if: success()
        run: |
          if [ "$(echo "${{ steps.check_instances.outputs.output }}" | jq length)" -gt 0 ]; then
            echo "❌ 发现正在运行/非终止状态的 VM.Standard.A1.Flex 实例，终止工作流"
            exit 1
          else
            echo "✅ 没有运行中的 VM.Standard.A1.Flex 实例，继续执行"
          fi

      - name: Get Availability Domain Name
        id: get_availability_domain
        if: success()
        uses: oracle-actions/run-oci-cli-command@v1.3.2
        with:
          silent: false
          command: 'iam availability-domain list --compartment-id ${{ env.COMPARTMENT_ID }}'
          query: 'data[0]."name"'

      - name: Get VCN ID
        id: get_vcn_id
        if: success()
        uses: oracle-actions/run-oci-cli-command@v1.3.2
        with:
          silent: false
          command: 'network vcn list --compartment-id ${{ env.COMPARTMENT_ID }}'
          query: 'data[0]."id"'

      - name: Get Subnet ID
        id: get_subnet_id
        if: success()
        uses: oracle-actions/run-oci-cli-command@v1.3.2
        with:
          silent: false
          command: 'network subnet list --compartment-id ${{ env.COMPARTMENT_ID }} --vcn-id ${{ steps.get_vcn_id.outputs.output }}'
          query: 'data[0]."id"'

      # 创建实例
      - name: Create new Ubuntu ARM instance (4C24G)
        if: success()
        # uses: oracle-actions/run-oci-cli-command@v1.3.2
        run: |
          oci compute instance launch \
            --availability-domain ${{ steps.get_availability_domain.outputs.output }} \
            --compartment-id "${{ env.COMPARTMENT_ID }}" \
            --shape "${{ env.INSTANCE_SHAPE }}" \
            --shape-config '{"ocpus": ${{ env.OCPUS }}, "memoryInGBs": ${{ env.MEMORY_GB }}}' \
            --display-name "ubuntu-arm-4c24g" \
            --image-id "${{ env.IMAGE_ID }}" \
            --subnet-id "${{ steps.get_subnet_id.outputs.output }}" \
            --ssh-authorized-keys-file <(echo "${{ SSH_PUBLIC_KEY }}") \
            --assign-public-ip true
